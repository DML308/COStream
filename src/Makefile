MYNAME  = Makefile
CC      = gcc
YACC    = bison -y
LEX     = flex

# The flags in CFLAGS are classified into warning flags (in WARNINGS)
# and all others (in _CFLAGS).  Code generated by bison and flex rarely
# passes gcc -Wall without generating warnings, so we use only _CFLAGS
# to compile such code.
_CFLAGS = -g #-DNO_STDARG -DNO_STRTOUL -DNO_PROTOTYPES
WARNINGS = -Wall -Wcast-align -Wwrite-strings -Wcast-qual
CFLAGS  = $(_CFLAGS) $(WARNINGS)


# These are the source and object files for the parser
MSRC =  ast.c            complex-types.c  container.c    \
        constexpr.c      conversions.c    initializer.c  \
        list.c           main.c           operators.c    \
        output.c         print-ast.c      procedure.c    \
        sem-check.c      strings.c        sue.c          \
        symbol.c         transform.c      type.c         \
        type2.c          verify-parse.c   warning.c      \
        dataflow.c       analyze.c

MOBJ = $(MSRC:.c=.o)

PSRC =  c4.l ANSI-C.y
PC   =  lex.c parser.c
POBJ =  lex.o parser.o

SRC  = $(PSRC) $(MSRC)
CSRC = $(PC)  $(MSRC)
OBJ  = $(POBJ) $(MOBJ)

# These are the top level rules
c2c:  $(OBJ)
	$(CC) $(_CFLAGS) -o c2c $(OBJ)

#dparse: $(OBJ)
#	$(CC) $(_CFLAGS) -o dparse $(OBJ) /usr/lib/debug/malloc.o

parser.c y.tab.h: ANSI-C.y
	$(YACC) -dv ANSI-C.y
	mv y.tab.c parser.c

lex.c: c4.l y.tab.h
	$(LEX) c4.l
	mv lex.yy.c lex.c

lex.o: lex.c
	$(CC) $(_CFLAGS) -I. -c lex.c -o lex.o

parser.o: parser.c
	$(CC) $(_CFLAGS) -DYYDEBUG -I. -c parser.c -o parser.o

clean:
	rm -f lex.c lex.yy.c parser.c y.tab.[ch] *~ *.bak *.orig core y.output tmp* *.o .\#*

reset: clean
	rm -f c2c

depend: $(PC)
	makedepend -f $(MYNAME) -- $(CFLAGS) -- $(CSRC)

tags:
	ctags -f tags $(SRC)
	etags -f TAGS $(SRC)

# DO NOT DELETE THIS LINE -- make depend depends on it.
